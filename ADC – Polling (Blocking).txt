#include "stm32f103x6.h"

void ADC1_Init(void)
{
    RCC->APB2ENR |= RCC_APB2ENR_ADC1EN;

    ADC1->SQR3 = 0;          // Channel 0 (PA0)
    ADC1->SMPR2 = 7 << 0;    // Sample time 239.5 cycles
    ADC1->CR2 |= ADC_CR2_ADON;
}

uint16_t ADC1_Read_Polling(void)
{
    ADC1->CR2 |= ADC_CR2_ADON; // start conversion
    while(!(ADC1->SR & ADC_SR_EOC)); // wait until conversion done (blocking)
    return ADC1->DR;
}

int main(void)
{
    ADC1_Init();
    while(1)
    {
        uint16_t val = ADC1_Read_Polling(); // Blocking read
    }
}
