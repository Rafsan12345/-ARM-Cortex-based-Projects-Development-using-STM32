#include "stm32f103x6.h"

uint8_t rx_data;

void UART1_Init_IT(void)
{
    RCC->APB2ENR |= RCC_APB2ENR_USART1EN | RCC_APB2ENR_IOPAEN;

    GPIOA->CRH &= ~(GPIO_CRH_MODE9 | GPIO_CRH_CNF9);
    GPIOA->CRH |= GPIO_CRH_MODE9_1 | GPIO_CRH_CNF9_1;
    GPIOA->CRH &= ~(GPIO_CRH_MODE10 | GPIO_CRH_CNF10);
    GPIOA->CRH |= GPIO_CRH_CNF10_0;

    USART1->BRR = 72000000/9600;
    USART1->CR1 = USART_CR1_TE | USART_CR1_RE | USART_CR1_UE | USART_CR1_RXNEIE;

    NVIC_EnableIRQ(USART1_IRQn);
}

void USART1_IRQHandler(void)
{
    if(USART1->SR & USART_SR_RXNE)
    {
        rx_data = USART1->DR;            // Read data
        USART1->DR = rx_data;            // Echo back
    }
}

int main(void)
{
    UART1_Init_IT();
    while(1)
    {
        // Main loop free, MCU not blocked
    }
}
